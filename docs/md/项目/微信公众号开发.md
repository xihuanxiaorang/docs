---
outline: [2,3]
---

# å¾®ä¿¡å…¬ä¼—å·å¼€å‘

## æ¦‚è¿°

1. **å¾®ä¿¡å…¬ä¼—å¹³å°**ï¼šä¸ºå…¬ä¼—å·è¿è¥è€…æä¾›èµ„è®¯å’ŒæœåŠ¡çš„å¹³å°ï¼Œé€šè¿‡å¼€æ”¾æ¥å£å®ç°åŠŸèƒ½ã€‚
2. **ç”¨æˆ·è¯†åˆ«**ï¼šæ¯ä¸ªç”¨æˆ·å¯¹å…¬ä¼—å·æœ‰å”¯ä¸€ OpenIDï¼Œå¤šä¸ªå…¬ä¼—å·å’Œåº”ç”¨å¯é€šè¿‡ UnionID è¯†åˆ«åŒä¸€ç”¨æˆ·ã€‚
3. **å¼€å‘è€…æ³¨æ„äº‹é¡¹**ï¼š
   - å¾®ä¿¡å…¬ä¼—å¹³å°å¼€å‘åŒ…æ‹¬ä¸ºå…¬ä¼—å·ã€ç§»åŠ¨åº”ç”¨ã€PCç«¯ç½‘ç«™å’Œç¬¬ä¸‰æ–¹å¹³å°æä¾›æœåŠ¡ã€‚
   - åœ¨ç”³è¯·è®¤è¯å…¬ä¼—å·å‰ï¼Œå¯ä»¥é€šè¿‡æµ‹è¯•å·ç”³è¯·ç³»ç»Ÿå¿«é€Ÿ[ç”³è¯·æ¥å£æµ‹è¯•å·](#æ¥å£æµ‹è¯•å·ç”³è¯·)è¿›è¡Œå¼€å‘ã€‚
   - å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨æ¥å£è°ƒè¯•å·¥å…·åœ¨çº¿è°ƒè¯•æ¥å£ã€‚
   - æ¯ä¸ªæ¥å£æœ‰æ¯æ—¥è°ƒç”¨é¢‘æ¬¡é™åˆ¶ï¼Œå¯åœ¨å¼€å‘è€…ä¸­å¿ƒæŸ¥çœ‹ã€‚
   - é€šè¿‡æ¥å£è¿”å›ç å’ŒæŠ¥è­¦æ’æŸ¥æŒ‡å¼•å‘ç°å’Œè§£å†³é—®é¢˜ã€‚
   - <strong style="color:#ae3520;">ä½¿ç”¨ access_token ä½œä¸ºæ¥å£è°ƒç”¨å‡­æ®ï¼Œæœ‰æ•ˆæœŸä¸º 2 å°æ—¶ï¼Œ<u>éœ€è‡ªè¡Œå­˜å‚¨</u></strong>ã€‚
4. **å…¬ä¼—å·æœåŠ¡æ–¹å¼**ï¼š
   - **å…¬ä¼—å·æ¶ˆæ¯ä¼šè¯**ï¼šåŒ…æ‹¬ç¾¤å‘æ¶ˆæ¯ã€è¢«åŠ¨å›å¤æ¶ˆæ¯ã€å®¢æœæ¶ˆæ¯å’Œæ¨¡æ¿æ¶ˆæ¯ã€‚
   - **å…¬ä¼—å·å†…ç½‘é¡µ**ï¼šåŒ…æ‹¬ç½‘é¡µæˆæƒè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œå¾®ä¿¡ JS-SDKï¼Œç”¨äºåœ¨ç½‘é¡µä¸Šä½¿ç”¨å¾®ä¿¡åŸç”ŸåŠŸèƒ½ã€‚

## æ¥å£æµ‹è¯•å·ç”³è¯·

ç”±äºç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§æ–¹é¢çš„è€ƒè™‘ï¼Œå¾®ä¿¡å…¬ä¼—å·çš„æ³¨å†Œæœ‰ä¸€å®šé—¨æ§›ï¼ŒæŸäº›é«˜çº§æ¥å£çš„æƒé™éœ€è¦å¾®ä¿¡è®¤è¯åæ‰å¯ä»¥è·å–ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†å¸®åŠ©å¼€å‘è€…å¿«é€Ÿäº†è§£å’Œä¸Šæ‰‹å¾®ä¿¡å…¬ä¼—å·å¼€å‘ï¼Œç†Ÿæ‚‰å„ä¸ªæ¥å£çš„è°ƒç”¨ï¼Œå¾®ä¿¡å®˜æ–¹æ¨å‡ºäº†å¾®ä¿¡å…¬ä¼—è´¦å·æµ‹è¯•å·ï¼Œé€šè¿‡æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç å³å¯è·å¾—æµ‹è¯•å·ã€‚

[è¿›å…¥å¾®ä¿¡å…¬ä¼—è´¦å·æµ‹è¯•å·ç”³è¯·ç³»ç»Ÿ](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login) <br />![](https://cdn.jsdelivr.net/gh/xihuanxiaorang/img2/202411191713410.png)

## é¡¹ç›®åˆå§‹åŒ–

åˆ›å»ºä¸€ä¸ª SpringBoot å·¥ç¨‹ä½œä¸ºå¾®ä¿¡å…¬ä¼—å·å¼€å‘çš„åç«¯æœåŠ¡å™¨ã€‚

1. å¼•å…¥ `wx-java-mp-spring-boot-starter` ä¾èµ–ç”¨äºå¿«é€Ÿå¼€å‘å¾®ä¿¡å…¬ä¼—å·ï¼›
2. åœ¨ `application.yml` æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­å¢åŠ å¾®ä¿¡å…¬ä¼—å·å¼€å‘æ—¶çš„å¿…è¦é…ç½®ï¼Œå¦‚ <u>appid</u>ã€<u>appsecret</u>ã€<u>token</u> ç­‰ã€‚<br />![](https://cdn.jsdelivr.net/gh/xihuanxiaorang/img2/202411191835745.png)

::: code-group

```xml [pom.xml] {17,30-35,44-47}
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>fun.xiaorang</groupId>
  <artifactId>weixin-java-mp-demo</artifactId>
  <version>1.0-SNAPSHOT</version>

  <properties>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven-compiler-plugin.version>3.11.0</maven-compiler-plugin.version>
    <springboot.version>3.2.3</springboot.version>
    <wx-java-mp.version>4.6.7.B</wx-java-mp.version>
  </properties>

  <dependencyManagement>
    <dependencies>
      <!-- SpringBoot ä¾èµ– -->
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>${springboot.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
      <!-- å¾®ä¿¡å…¬ä¼—å·Javaå¼€å‘åŒ… -->
      <dependency>
        <groupId>com.github.binarywang</groupId>
        <artifactId>wx-java-mp-spring-boot-starter</artifactId>
        <version>${wx-java-mp.version}</version>
      </dependency>
    </dependencies>
  </dependencyManagement>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>com.github.binarywang</groupId>
      <artifactId>wx-java-mp-spring-boot-starter</artifactId>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <!-- maven-compiler-plugin ç¼–è¯‘æ’ä»¶ -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>${maven-compiler-plugin.version}</version>  <!-- Replace with the version you need -->
        <configuration>
          <source>${maven.compiler.source}</source>
          <target>${maven.compiler.target}</target>
          <encoding>${project.build.sourceEncoding}</encoding>
          <!-- due to problem in maven-compiler-plugin, for verbose mode add showWarnings -->
          <showWarnings>true</showWarnings>
          <parameters>true</parameters>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>
```

```yaml [application.yml] {14-18}
server:
  port: 8888

spring:
  application:
    name: weixin-java-mp-demo
    
logging:
  level:
    org.springframework.web: INFO
    fun.xiaorang.demo.wx.mp: DEBUG
    me.chanjar.weixin: DEBUG

wx:
  mp:
    app-id: #å¡«å†™æµ‹è¯•å·çš„appID
    secret: #å¡«å†™æµ‹è¯•å·çš„appsecret
    token: #å¡«å†™æµ‹è¯•å·æ¥å£é…ç½®ä¿¡æ¯ä¸­çš„Token
```

:::

## æ¥å…¥æŒ‡å—

æ¥å…¥å¾®ä¿¡å…¬ä¼—å¹³å°å¼€å‘ï¼Œå¼€å‘è€…éœ€è¦æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®Œæˆï¼š

1. å¡«å†™æœåŠ¡å™¨é…ç½®
2. éªŒè¯æœåŠ¡å™¨åœ°å€çš„æœ‰æ•ˆæ€§
3. ä¾æ®æ¥å£æ–‡æ¡£å®ç°ä¸šåŠ¡é€»è¾‘

### ç¬¬ä¸€æ­¥ï¼šå¡«å†™æœåŠ¡å™¨é…ç½®

> [!important]
>
> ç¡®ä¿å·²å¼€å¯[å†…ç½‘ç©¿é€](..\æ‚è®°\å·¥å…·\å¼€å‘è€…å·¥å…·\å†…ç½‘ç©¿é€å·¥å…·.md#åŸŸåè§£æ) ï¼Œä½¿å¾—å¾®ä¿¡å…¬ä¼—å·æœåŠ¡å™¨èƒ½è®¿é—®æœ¬åœ°é¡¹ç›®ï¼

- æœåŠ¡å™¨åœ°å€ URLï¼šæ˜¯å¼€å‘è€…ç”¨æ¥æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯å’Œäº‹ä»¶çš„æ¥å£ URLã€‚
  - `mp.xiaorang.fun` æ˜ å°„åˆ°æœ¬åœ°çš„ `127.0.0.1:8888` ç«¯å£ï¼Œæ­£å¥½å¯¹åº”åç«¯æœåŠ¡å™¨åœ°å€ã€‚
  - `/wx/mp/portal/appId` ä½œä¸º[éªŒè¯æœåŠ¡å™¨åœ°å€æœ‰æ•ˆæ€§](#ç¬¬äºŒæ­¥-éªŒè¯æœåŠ¡å™¨åœ°å€çš„æœ‰æ•ˆæ€§)çš„æ¥å£åœ°å€ï¼Œå…¶ä¸­æ¥å£è·¯å¾„ä¸Šçš„ appId éœ€è¦æ›¿æ¢æˆè‡ªå·±æµ‹è¯•å·çš„ appIDã€‚
- Tokenï¼šå¯ç”±å¼€å‘è€…å¯ä»¥ä»»æ„å¡«å†™ï¼Œç”¨ä½œç”Ÿæˆç­¾åï¼ˆè¯¥ Token ä¼šå’Œæ¥å£ URL ä¸­åŒ…å«çš„ Token è¿›è¡Œæ¯”å¯¹ï¼Œä»è€ŒéªŒè¯å®‰å…¨æ€§ã€‚

![](https://cdn.jsdelivr.net/gh/xihuanxiaorang/img2/202411191818084.png)

### ç¬¬äºŒæ­¥ï¼šéªŒè¯æœåŠ¡å™¨åœ°å€çš„æœ‰æ•ˆæ€§

å¼€å‘è€…æäº¤ä¿¡æ¯åï¼Œå¾®ä¿¡æœåŠ¡å™¨å°†å‘é€ GET è¯·æ±‚åˆ°å¡«å†™çš„æœåŠ¡å™¨åœ°å€ URL ä¸Šï¼ŒGET è¯·æ±‚æºå¸¦å‚æ•°å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| å‚æ•°      | æè¿°                                                         |
| :-------- | :----------------------------------------------------------- |
| signature | å¾®ä¿¡åŠ å¯†ç­¾åï¼Œsignatureç»“åˆäº†å¼€å‘è€…å¡«å†™çš„tokenå‚æ•°å’Œè¯·æ±‚ä¸­çš„timestampå‚æ•°ã€nonceå‚æ•°ã€‚ |
| timestamp | æ—¶é—´æˆ³                                                       |
| nonce     | éšæœºæ•°                                                       |
| echostr   | éšæœºå­—ç¬¦ä¸²                                                   |

å¼€å‘è€…é€šè¿‡æ£€éªŒ signature å¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒã€‚è‹¥ç¡®è®¤æ­¤æ¬¡ GET è¯·æ±‚æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨ï¼Œè¯·åŸæ ·è¿”å› echostr å‚æ•°å†…å®¹ï¼Œåˆ™æ¥å…¥ç”Ÿæ•ˆï¼Œæˆä¸ºå¼€å‘è€…æˆåŠŸï¼Œå¦åˆ™æ¥å…¥å¤±è´¥ã€‚

ç”¨äºéªŒè¯æœåŠ¡å™¨åœ°å€æœ‰æ•ˆæ€§çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼šå‚è€ƒè‡ª WxJava å…³äºå¾®ä¿¡å…¬ä¼—å·å¼€å‘çš„[ç¤ºä¾‹ä»£ç ](https://github.com/binarywang/weixin-java-mp-demo/blob/master/src/main/java/com/github/binarywang/demo/wx/mp/controller/WxPortalController.java)

```java
@Slf4j
@RequiredArgsConstructor
@RestController
@RequestMapping("/wx/mp/portal/{appId}")
public class WxMpPortalController {
  private final WxMpService wxService;

  @GetMapping(produces = "text/plain;charset=utf-8")
  public String authGet(@PathVariable String appId, @RequestParam(name = "signature", required = false) String signature, @RequestParam(name = "timestamp", required = false) String timestamp, @RequestParam(name = "nonce", required = false) String nonce, @RequestParam(name = "echostr", required = false) String echostr) {
    log.info("\næ”¶åˆ°æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„è®¤è¯æ¶ˆæ¯ï¼š [signature=[{}], timestamp=[{}], nonce=[{}], echostr=[{}]]", signature, timestamp, nonce, echostr);
    if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) {
      throw new IllegalArgumentException("è¯·æ±‚å‚æ•°éæ³•ï¼Œè¯·æ ¸å®ï¼");
    }
    if (!this.wxService.switchover(appId)) {
      throw new IllegalArgumentException(String.format("æœªæ‰¾åˆ°å¯¹åº”appid=[%s]çš„é…ç½®ï¼Œè¯·æ ¸å®ï¼", appId));
    }
    if (!this.wxService.checkSignature(timestamp, nonce, signature)) {
      throw new IllegalArgumentException("éæ³•è¯·æ±‚ï¼Œå¯èƒ½å±äºä¼ªé€ çš„è¯·æ±‚ï¼");
    }
    return echostr;
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šä¾æ®æ¥å£æ–‡æ¡£å®ç°ä¸šåŠ¡é€»è¾‘

éªŒè¯ URL æœ‰æ•ˆæ€§æˆåŠŸåå³æ¥å…¥ç”Ÿæ•ˆï¼Œæˆä¸ºå¼€å‘è€…ã€‚å¯ä»¥åœ¨å…¬ä¼—å¹³å°ç½‘ç«™ä¸­ç”³è¯·å¾®ä¿¡è®¤è¯ï¼Œè®¤è¯æˆåŠŸåï¼Œå°†è·å¾—æ›´å¤šæ¥å£æƒé™ï¼Œæ»¡è¶³æ›´å¤šä¸šåŠ¡éœ€æ±‚ã€‚

æˆä¸ºå¼€å‘è€…åï¼Œç”¨æˆ·æ¯æ¬¡å‘å…¬ä¼—å·å‘é€æ¶ˆæ¯ã€æˆ–è€…äº§ç”Ÿè‡ªå®šä¹‰èœå•ã€æˆ–äº§ç”Ÿå¾®ä¿¡æ”¯ä»˜è®¢å•ç­‰æƒ…å†µæ—¶ï¼Œ<strong style="color:#ae3520;">å¼€å‘è€…å¡«å†™çš„æœåŠ¡å™¨é…ç½® URL å°†å¾—åˆ°å¾®ä¿¡æœåŠ¡å™¨æ¨é€è¿‡æ¥çš„æ¶ˆæ¯å’Œäº‹ä»¶</strong>ï¼Œå¼€å‘è€…å¯ä»¥ä¾æ®è‡ªèº«ä¸šåŠ¡é€»è¾‘è¿›è¡Œå“åº”ï¼Œå¦‚å›å¤æ¶ˆæ¯ã€‚

å…¬ä¼—å·è°ƒç”¨å„æ¥å£æ—¶ï¼Œä¸€èˆ¬ä¼šè·å¾—æ­£ç¡®çš„ç»“æœï¼Œå…·ä½“ç»“æœå¯è§å¯¹åº”æ¥å£çš„è¯´æ˜ã€‚è¿”å›é”™è¯¯æ—¶ï¼Œå¯æ ¹æ®è¿”å›ç æ¥æŸ¥è¯¢é”™è¯¯åŸå› ã€‚[å…¨å±€è¿”å›ç è¯´æ˜](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Global_Return_Code.html)

ç”¨æˆ·å‘å…¬ä¼—å·å‘é€æ¶ˆæ¯æ—¶ï¼Œå…¬ä¼—å·æ–¹æ”¶åˆ°çš„æ¶ˆæ¯å‘é€è€…æ˜¯ä¸€ä¸ª OpenIDï¼Œæ˜¯ä½¿ç”¨ç”¨æˆ·å¾®ä¿¡å·åŠ å¯†åçš„ç»“æœï¼Œ<strong style="color:#ae3520;">æ¯ä¸ªç”¨æˆ·å¯¹æ¯ä¸ªå…¬ä¼—å·æœ‰ä¸€ä¸ªå”¯ä¸€çš„ OpenID</strong>ã€‚

æ­¤å¤–ï¼Œç”±äºå¼€å‘è€…ç»å¸¸æœ‰éœ€åœ¨å¤šä¸ªå¹³å°ï¼ˆç§»åŠ¨åº”ç”¨ã€ç½‘ç«™ã€å…¬ä¼—è´¦å·ï¼‰ä¹‹é—´å…±é€šç”¨æˆ·è´¦å·ï¼Œç»Ÿä¸€è´¦å·ä½“ç³»çš„éœ€æ±‚ï¼Œå¾®ä¿¡å¼€æ”¾å¹³å°ï¼ˆ[open.weixin.qq.com](http://open.weixin.qq.com/)ï¼‰æä¾›äº† UnionID æœºåˆ¶ã€‚<u>å¼€å‘è€…å¯é€šè¿‡ OpenID æ¥è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</u>ï¼Œè€Œå¦‚æœå¼€å‘è€…æ‹¥æœ‰å¤šä¸ªåº”ç”¨ï¼ˆç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨å’Œå…¬ä¼—è´¦å·ï¼Œå…¬ä¼—è´¦å·åªæœ‰åœ¨è¢«ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹åï¼Œæ‰ä¼šè·å– UnionIDï¼‰ï¼Œå¯é€šè¿‡è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ä¸­çš„ UnionID æ¥åŒºåˆ†ç”¨æˆ·çš„å”¯ä¸€æ€§ï¼Œå› ä¸ºåªè¦æ˜¯åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹çš„ç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨å’Œå…¬ä¼—è´¦å·ï¼Œç”¨æˆ·çš„ UnionID æ˜¯å”¯ä¸€çš„ã€‚æ¢å¥è¯è¯´ï¼Œ<strong style="color:#ae3520;">åŒä¸€ç”¨æˆ·ï¼Œå¯¹åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹çš„ä¸åŒåº”ç”¨ï¼ŒUnionID æ˜¯ç›¸åŒçš„</strong>ã€‚è¯¦æƒ…è¯·åœ¨å¾®ä¿¡å¼€æ”¾å¹³å°çš„èµ„æºä¸­å¿ƒ-ç§»åŠ¨åº”ç”¨å¼€å‘-å¾®ä¿¡ç™»å½•-æˆæƒå…³ç³»æ¥å£è°ƒç”¨æŒ‡å¼•-è·å–ç”¨æˆ·ä¸ªäººä¿¡æ¯ï¼ˆUnionIDæœºåˆ¶ï¼‰ä¸­æŸ¥çœ‹ã€‚

## æ¶ˆæ¯å¤„ç†

<strong style="color:#ae3520;">å½“ç”¨æˆ·å‘å¾®ä¿¡å…¬ä¼—å·å‘é€æ¶ˆæ¯æ—¶ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå°† POST æ¶ˆæ¯è½¬å‘åˆ°å¼€å‘è€…é…ç½®çš„æœåŠ¡å™¨æ¥å£</strong>ã€‚

```java {24-63}
@Slf4j
@RequiredArgsConstructor
@RestController
@RequestMapping("/wx/mp/portal/{appId}")
public class WxMpPortalController {
  private final WxMpService wxService;
  private final WxMpMessageRouter messageRouter;

  @GetMapping(produces = "text/plain;charset=utf-8")
  public String authGet(@PathVariable String appId, @RequestParam(name = "signature", required = false) String signature, @RequestParam(name = "timestamp", required = false) String timestamp, @RequestParam(name = "nonce", required = false) String nonce, @RequestParam(name = "echostr", required = false) String echostr) {
    log.info("\næ”¶åˆ°æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„è®¤è¯æ¶ˆæ¯ï¼š [signature=[{}], timestamp=[{}], nonce=[{}], echostr=[{}]]", signature, timestamp, nonce, echostr);
    if (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) {
      throw new IllegalArgumentException("è¯·æ±‚å‚æ•°éæ³•ï¼Œè¯·æ ¸å®ï¼");
    }
    if (!this.wxService.switchover(appId)) {
      throw new IllegalArgumentException(String.format("æœªæ‰¾åˆ°å¯¹åº”appid=[%s]çš„é…ç½®ï¼Œè¯·æ ¸å®ï¼", appId));
    }
    if (!this.wxService.checkSignature(timestamp, nonce, signature)) {
      throw new IllegalArgumentException("éæ³•è¯·æ±‚ï¼Œå¯èƒ½å±äºä¼ªé€ çš„è¯·æ±‚ï¼");
    }
    return echostr;
  }

  @PostMapping(produces = "application/xml; charset=UTF-8")
  public String handleMessage(@PathVariable String appId, @RequestBody String requestBody, @RequestParam("signature") String signature, @RequestParam("timestamp") String timestamp, @RequestParam("nonce") String nonce, @RequestParam("openid") String openid, @RequestParam(name = "encrypt_type", required = false) String encType, @RequestParam(name = "msg_signature", required = false) String msgSignature) {
    log.info("\næ¥æ”¶å¾®ä¿¡è¯·æ±‚ï¼š[openid=[{}], [signature=[{}], encType=[{}], msgSignature=[{}], timestamp=[{}], nonce=[{}], requestBody=[\n{}\n] ", openid, signature, encType, msgSignature, timestamp, nonce, requestBody);
    if (!this.wxService.switchover(appId)) {
      throw new IllegalArgumentException(String.format("æœªæ‰¾åˆ°å¯¹åº”appid=[%s]çš„é…ç½®ï¼Œè¯·æ ¸å®ï¼", appId));
    }
    if (!this.wxService.checkSignature(timestamp, nonce, signature)) {
      throw new IllegalArgumentException("éæ³•è¯·æ±‚ï¼Œå¯èƒ½å±äºä¼ªé€ çš„è¯·æ±‚ï¼");
    }
    String out = null;
    if (encType == null) {
      // æ˜æ–‡ä¼ è¾“çš„æ¶ˆæ¯
      WxMpXmlMessage inMessage = WxMpXmlMessage.fromXml(requestBody);
      WxMpXmlOutMessage outMessage = this.route(inMessage);
      if (outMessage == null) {
        return "";
      }
      out = outMessage.toXml();
    } else if ("aes".equalsIgnoreCase(encType)) {
      // aesåŠ å¯†çš„æ¶ˆæ¯
      WxMpXmlMessage inMessage = WxMpXmlMessage.fromEncryptedXml(requestBody, wxService.getWxMpConfigStorage(), timestamp, nonce, msgSignature);
      log.debug("\næ¶ˆæ¯è§£å¯†åå†…å®¹ä¸ºï¼š\n{} ", inMessage.toString());
      WxMpXmlOutMessage outMessage = this.route(inMessage);
      if (outMessage == null) {
        return "";
      }
      out = outMessage.toEncryptedXml(wxService.getWxMpConfigStorage());
    }
    log.debug("\nç»„è£…å›å¤ä¿¡æ¯ï¼š{}", out);
    return out;
  }

  private WxMpXmlOutMessage route(WxMpXmlMessage message) {
    try {
      return this.messageRouter.route(message);
    } catch (Exception e) {
      log.error("è·¯ç”±æ¶ˆæ¯æ—¶å‡ºç°å¼‚å¸¸ï¼", e);
    }
    return null;
  }
}
```

`handleMessage()` æ–¹æ³•ç”¨äºæ¥æ”¶å’Œå¤„ç†æ¥è‡ªå¾®ä¿¡æœåŠ¡å™¨çš„æ¨é€æ¶ˆæ¯ã€‚å®ƒæ”¯æŒæ˜æ–‡å’ŒåŠ å¯†ä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼Œå¹¶ä¸”é€šè¿‡æ¶ˆæ¯è·¯ç”±å™¨å°†æ¶ˆæ¯è·¯ç”±åˆ°é€‚å½“çš„æ¶ˆæ¯å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚

### æ¶ˆæ¯å¤„ç†å™¨

#### ç®€ä»‹

`WxMpMessageHandler` æ˜¯å¾®ä¿¡å…¬ä¼—å·å¼€å‘ä¸­ç”¨äºå¤„ç†æ¶ˆæ¯çš„æ¥å£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªè§„èŒƒï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥é€šè¿‡å®ç°è¿™ä¸ªæ¥å£æ¥å®šåˆ¶å¦‚ä½•å¤„ç†ä»å¾®ä¿¡æœåŠ¡å™¨æ¨é€è¿‡æ¥çš„å„ç§æ¶ˆæ¯ï¼Œæ¯”å¦‚æ–‡æœ¬æ¶ˆæ¯ã€å›¾ç‰‡æ¶ˆæ¯ã€è¯­éŸ³æ¶ˆæ¯ç­‰ã€‚

`WxMpMessageHandler` çš„æ ¸å¿ƒæ˜¯ `handle` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºæ¥æ”¶æ¶ˆæ¯å¹¶è¿”å›å“åº”æ¶ˆæ¯ã€‚å…¶ç­¾åå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
WxMpXmlOutMessage handle(WxMpXmlMessage wxMessage, 
                         Map<String, Object> context, 
                         WxMpService wxMpService, 
                         WxSessionManager sessionManager) throws WxErrorException;
```

- `wxMessage`ï¼šå¾®ä¿¡æ¨é€çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«æ¶ˆæ¯çš„å†…å®¹å’Œå…ƒæ•°æ®ã€‚
- `context`ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ç”¨äºå­˜å‚¨å…±äº«æ•°æ®ã€‚
- `wxMpService`ï¼šæä¾›è°ƒç”¨å¾®ä¿¡æ¥å£çš„å·¥å…·ç±»ï¼Œä¾‹å¦‚å‘é€æ¶ˆæ¯ã€è·å–ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚
- `sessionManager`ï¼šä¼šè¯ç®¡ç†å™¨ï¼Œç”¨äºè·Ÿè¸ªç”¨æˆ·ä¼šè¯çŠ¶æ€ã€‚

#### ä½¿ç”¨åœºæ™¯

<strong style="color:#ae3520;">å½“ç”¨æˆ·å‘å¾®ä¿¡å…¬ä¼—å·å‘é€æ¶ˆæ¯æ—¶ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå°† POST æ¶ˆæ¯è½¬å‘åˆ°å¼€å‘è€…é…ç½®çš„æœåŠ¡å™¨æ¥å£</strong>ã€‚åœ¨åç«¯ä»£ç ä¸­ï¼Œé€šè¿‡å®ç° `WxMpMessageHandler`æ¥å£ï¼Œå¯ä»¥ç¼–å†™é€»è¾‘æ¥å¯¹ä¸åŒç±»å‹çš„æ¶ˆæ¯è¿›è¡Œé’ˆå¯¹æ€§å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå½“æ”¶åˆ°ç”¨æˆ·å‘é€çš„æ–‡æœ¬æ¶ˆæ¯ â€œæŸ¥è¯¢è®¢å•â€ æ—¶ï¼Œå¯ä»¥åœ¨ `WxMpMessageHandler` çš„å®ç°ç±»ä¸­ç¼–å†™ä»£ç ï¼Œè¿æ¥æ•°æ®åº“æŸ¥è¯¢è®¢å•ä¿¡æ¯ï¼Œç„¶åå°†æŸ¥è¯¢ç»“æœå›å¤ç»™ç”¨æˆ·ã€‚

#### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ `WxMpMessageHandler` å®ç°ç¤ºä¾‹ï¼Œç”¨äºå¤„ç†æ–‡æœ¬æ¶ˆæ¯å¹¶å›å¤ç›¸åŒçš„å†…å®¹ï¼š

```java
@Component
public class EchoMessageHandler implements WxMpMessageHandler {
  @Override
  public WxMpXmlOutMessage handle(final WxMpXmlMessage wxMessage, final Map<String, Object> context, final WxMpService wxMpService, final WxSessionManager sessionManager) {
    return WxMpXmlOutMessage.TEXT().content(wxMessage.getContent()).fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser()).build();
  }
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`EchoMessageHandler` ç±»å®ç°äº† `WxMpMessageHandler` æ¥å£ã€‚å…¶ä¸­çš„ `handle` æ–¹æ³•æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯å¯¹è±¡ `WxMpXmlMessage`ã€ä¸€ä¸ª `Map` å¯¹è±¡ï¼ˆç”¨äºå­˜å‚¨é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰å’Œ `WxMpService`ï¼ˆç”¨äºè°ƒç”¨å¾®ä¿¡å…¬ä¼—å·ç›¸å…³çš„æœåŠ¡æ¥å£ï¼‰ã€‚å®ƒä»æ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­è·å–å†…å®¹ï¼Œå¹¶æ„å»ºä¸€ä¸ªæ–°çš„æ–‡æœ¬æ¶ˆæ¯å¯¹è±¡ `WxMpXmlOutTextMessage`ï¼Œå°†æ¥æ”¶åˆ°çš„å†…å®¹åŸå°ä¸åŠ¨åœ°å›å¤ç»™ç”¨æˆ·ã€‚

### æ¶ˆæ¯è·¯ç”±å™¨

#### ç®€ä»‹

`WxMpMessageRouter` æ˜¯æ¶ˆæ¯è·¯ç”±å™¨ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯<strong style="color:#ae3520;">æ ¹æ®æ¶ˆæ¯çš„ç±»å‹ã€å†…å®¹ã€æ¥æºç­‰å¤šç§å› ç´ ï¼Œå°†æ¶ˆæ¯åˆ†å‘ç»™ç›¸åº”çš„å¤„ç†å™¨ `WxMpMessageHandler` è¿›è¡Œå¤„ç†ã€‚å®ƒæ˜¯æ¶ˆæ¯å¤„ç†é€»è¾‘çš„æ ¸å¿ƒè°ƒåº¦å·¥å…·</strong>ã€‚

**ä½œç”¨**ï¼š

- æ ¹æ®æ¶ˆæ¯å†…å®¹ï¼ˆå¦‚æ¶ˆæ¯ç±»å‹ã€å…³é”®è¯ç­‰ï¼‰åŠ¨æ€é€‰æ‹©åˆé€‚çš„å¤„ç†å™¨ `WxMpMessageHandler`ã€‚
- æ”¯æŒå¤šä¸ªæ¡ä»¶ï¼ˆå¦‚æ¶ˆæ¯ç±»å‹å’Œç”¨æˆ·æ ‡ç­¾ï¼‰ç»„åˆè·¯ç”±ã€‚
- æä¾›é“¾å¼è°ƒç”¨çš„æ–¹å¼ï¼Œé…ç½®ç®€å•çµæ´»ã€‚

**ä¸»è¦æ–¹æ³•**ï¼š

- `rule()`ï¼šå®šä¹‰ä¸€ä¸ªæ¶ˆæ¯è·¯ç”±è§„åˆ™ã€‚
- `handler()`ï¼šè®¾ç½®å¤„ç†è¯¥æ¶ˆæ¯çš„å¤„ç†å™¨ `WxMpMessageHandler`ã€‚
- `end()`ï¼šè§„åˆ™ç»“æŸï¼Œä»£è¡¨å¦‚æœä¸€ä¸ªæ¶ˆæ¯åŒ¹é…è¯¥è§„åˆ™ï¼Œé‚£ä¹ˆå®ƒå°†ä¸å†ä¼šè¿›å…¥å…¶ä»–è§„åˆ™ã€‚
- `next()`ï¼šè§„åˆ™ç»“æŸï¼Œä½†æ˜¯æ¶ˆæ¯è¿˜ä¼šè¿›å…¥å…¶ä»–è§„åˆ™ã€‚

> [!important]
>
> 1. <strong style="color:#ae3520;">é…ç½®è·¯ç”±è§„åˆ™æ—¶è¦æŒ‰ç…§<u>ä»ç»†åˆ°ç²—</u>çš„åŸåˆ™ï¼Œå¦åˆ™æ¶ˆæ¯å¯èƒ½ä¼šè¢«æå‰å¤„ç†</strong>
> 2. é»˜è®¤æƒ…å†µä¸‹æ¶ˆæ¯åªä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼Œé™¤éä½¿ç”¨ `next()` æ–¹æ³•
> 3. <strong style="color:#ae3520;">è§„åˆ™çš„ç»“æŸå¿…é¡»ä½¿ç”¨ `end()` æˆ–è€… `next() `æ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šç”Ÿæ•ˆ</strong>

#### ä½¿ç”¨åœºæ™¯

åœ¨ä¸€ä¸ªå¤æ‚çš„å¾®ä¿¡å…¬ä¼—å·åº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šæ”¶åˆ°å¤šç§ç±»å‹çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯¹äºä¸åŒçš„æ¶ˆæ¯å¯èƒ½æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç”¨æˆ·å‘é€çš„ â€œå®¢æœå’¨è¯¢â€ ç±»æ¶ˆæ¯ï¼Œéœ€è¦å°†å…¶è·¯ç”±åˆ°å®¢æœæ¶ˆæ¯å¤„ç†é€»è¾‘ï¼›å¯¹äº â€œæ´»åŠ¨æŠ¥åâ€ ç±»æ¶ˆæ¯ï¼Œéœ€è¦è·¯ç”±åˆ°æ´»åŠ¨æŠ¥åæ¶ˆæ¯å¤„ç†é€»è¾‘ã€‚`WxMpMessageRouter` å¯ä»¥å¸®åŠ©å¼€å‘è€…æ–¹ä¾¿åœ°å®ç°è¿™ç§æ¶ˆæ¯çš„åˆ†æµå¤„ç†ã€‚

#### ç¤ºä¾‹ä»£ç 

::: code-group

```java [WxMpConfiguration]
@RequiredArgsConstructor
@Configuration
public class WxMpConfiguration {
  private final LogHandler logHandler;
  private final MsgHandler msgHandler;

  @Bean
  public WxMpMessageRouter messageRouter(WxMpService wxMpService) {
    final WxMpMessageRouter newRouter = new WxMpMessageRouter(wxMpService);

    // è®°å½•æ‰€æœ‰äº‹ä»¶çš„æ—¥å¿— ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
    newRouter.rule().handler(this.logHandler).next();

    // é»˜è®¤ï¼Œå…œåº•æ–¹æ¡ˆ
    newRouter.rule().async(false).handler(this.msgHandler).end();

    return newRouter;
  }
}
```

```java [LogHandler]
@Slf4j
@Component
public class LogHandler implements WxMpMessageHandler {
  @Override
  public WxMpXmlOutMessage handle(final WxMpXmlMessage wxMessage, final Map<String, Object> context, final WxMpService wxMpService, final WxSessionManager sessionManager) {
    log.info("\næ¥æ”¶åˆ°è¯·æ±‚æ¶ˆæ¯ï¼Œå†…å®¹ï¼š{}", JSONUtil.toJsonStr(wxMessage));
    return null;
  }
}
```

```java [MsgHandler]
@Component
public class MsgHandler implements WxMpMessageHandler {
  @Override
  public WxMpXmlOutMessage handle(final WxMpXmlMessage wxMessage, final Map<String, Object> context, final WxMpService wxMpService, final WxSessionManager sessionManager) {
    String content = "æ”¶åˆ°ä¿¡æ¯å†…å®¹ï¼š" + JSONUtil.toJsonStr(wxMessage);
    return WxMpXmlOutMessage.TEXT().content(content).fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser()).build();
  }
}
```

:::

## å‚è€ƒèµ„æ–™ğŸ

- ğŸ“ƒæ–‡æ¡£
  - [å¾®ä¿¡å…¬ä¼—å·å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
  - [binarywang/WxJava: å¾®ä¿¡å¼€å‘ Java SDK ï¼Œæ”¯æŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ï¼Œå¼€æ”¾å¹³å°ï¼Œå°ç¨‹åºï¼Œä¼ä¸šå¾®ä¿¡ï¼Œè§†é¢‘å·ï¼Œå…¬ä¼—å·ç­‰çš„åç«¯å¼€å‘](https://github.com/binarywang/WxJava)
  - é¡¹ç›®å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥å‚è€ƒè¯¥æ¡ˆä¾‹ï¼š[binarywang/weixin-java-mp-demo: åŸºäºSpring Boot å’Œ WxJava å®ç°çš„å¾®ä¿¡å…¬ä¼—å·Javaåç«¯Demoï¼Œæ”¯æŒå¤šå…¬ä¼—å·](https://github.com/binarywang/weixin-java-mp-demo) 
- ğŸ“ºè§†é¢‘
  - [Javaå¾®ä¿¡å…¬ä¼—å·å¼€å‘ï¼ŒæŒæ¡å¾®ä¿¡å…¬ä¼—å·å®Œæ•´å¼€å‘æµç¨‹çš„javaé¡¹ç›®å®æˆ˜æ•™ç¨‹ - åƒé”‹æ•™è‚²](https://www.bilibili.com/video/BV1Av4y1V77b?vd_source=84272a2d7f72158b38778819be5bc6ad)
- ğŸ› ï¸å·¥å…·
  - [å¾®ä¿¡å…¬ä¼—å·åå°ç®¡ç†](https://mp.weixin.qq.com/cgi-bin/home?t=home/index&lang=zh_CN&token=771965772)
  - [å¾®ä¿¡å…¬ä¼—å¹³å°æµ‹è¯•è´¦å·](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index)
  - [å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£è°ƒè¯•å·¥å…·](https://mp.weixin.qq.com/debug?token=771965772&lang=zh_CN)
  - [å¾®ä¿¡ç½‘é¡µå¼€å‘ / webå¼€å‘è€…å·¥å…·](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Web_Developer_Tools.html)
